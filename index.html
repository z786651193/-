<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‡ä¸ªç›†å‹â€”â€”ä¹¦é¦™ä¼´ç»¿æ„ï¼Œé˜…è¯»å…±æˆé•¿</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-green: #4CAF50;
            --light-green: #E8F5E9;
            --cream-white: #F5F5F5;
            --light-gray: #757575;
            --border-gray: #E0E0E0;
            --warning-red: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        
        body {
            background-color: var(--cream-white);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* å‰å°æ ·å¼ */
        .frontend {
            background: linear-gradient(to bottom, var(--light-green), var(--cream-white));
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: var(--primary-green);
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--light-gray);
            font-size: 16px;
        }
        
        .main-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .checkin-btn {
            width: 100%;
            height: 150px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }
        
        .checkin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .checkin-btn:disabled {
            background-color: var(--border-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-section, .recent-records {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--primary-green);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-gray);
        }
        
        .progress-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .progress-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary-green) 0% 0%, var(--border-gray) 0% 100%);
            z-index: 1;
        }
        
        .progress-inner {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2;
            position: relative;
        }
        
        .progress-days {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-green);
        }
        
        .progress-text {
            font-size: 14px;
            color: var(--light-gray);
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-gray);
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        /* åå°æ ·å¼ */
        .backend {
            display: none;
            min-height: 100vh;
        }
        
        .admin-header {
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-layout {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: var(--light-green);
            border-left-color: var(--primary-green);
            color: var(--primary-green);
        }
        
        .menu-badge {
            background-color: var(--primary-green);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--cream-white);
        }
        
        .data-table {
            width: 100%;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--light-green);
            border-bottom: 1px solid var(--border-gray);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-gray);
        }
        
        th {
            background-color: var(--light-green);
            font-weight: bold;
            color: var(--primary-green);
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: white;
            border-top: 1px solid var(--border-gray);
        }
        
        .page-info {
            color: var(--light-gray);
        }
        
        .page-controls button {
            padding: 8px 15px;
            margin-left: 5px;
            background-color: white;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .page-controls button.active {
            background-color: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-gray);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--light-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-gray);
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--border-gray);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-red);
            color: white;
        }
        
        .success-message {
            text-align: center;
            padding: 20px;
        }
        
        .success-icon {
            font-size: 50px;
            color: var(--primary-green);
            margin-bottom: 20px;
        }
        
        /* ç™»å½•æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(to bottom right, var(--primary-green), var(--light-green));
        }
        
        .login-box {
            background-color: white;
            border-radius: 10px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: var(--primary-green);
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .user-type-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--border-gray);
        }
        
        .user-type {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: white;
            cursor: pointer;
        }
        
        .user-type.active {
            background-color: var(--primary-green);
            color: white;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .admin-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .progress-circle {
                width: 100px;
                height: 100px;
            }
            
            .progress-inner {
                width: 80px;
                height: 80px;
            }
        }

        .plant-info {
            background-color: var(--light-green);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .plant-name {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }
        
        .plant-id {
            color: var(--light-gray);
            font-size: 14px;
        }
        
        .today-checkin-indicator {
            background-color: #FFEB3B;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .user-bound-info {
            background-color: var(--light-green);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .welcome-message {
            font-size: 16px;
            color: var(--primary-green);
            margin-bottom: 10px;
        }
        
        .bound-plant {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-green);
        }
        
        .no-records {
            text-align: center;
            color: var(--light-gray);
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--light-gray);
        }
        
        .error-message {
            background-color: #ffebee;
            color: var(--warning-red);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1001;
        }
        
        .status-connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-disconnected {
            background-color: #f44336;
            color: white;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            display: none;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .bind-plant-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        /* ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†æ ·å¼ */
        .photo-upload-area {
            border: 2px dashed var(--border-gray);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload-area:hover {
            border-color: var(--primary-green);
            background-color: var(--light-green);
        }
        
        .photo-upload-area i {
            font-size: 48px;
            color: var(--light-gray);
            margin-bottom: 10px;
        }
        
        .file-size-warning {
            color: var(--warning-red);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .photo-preview-container {
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator status-disconnected" id="statusIndicator">æ•°æ®åº“æœªè¿æ¥</div>

    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-header">
                <h1>æµ‡ä¸ªç›†å‹</h1>
                <p>ä¹¦é¦™ä¼´ç»¿æ„ï¼Œé˜…è¯»å…±æˆé•¿</p>
            </div>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            
            <div class="user-type-selector" id="userTypeSelector">
                <div class="user-type active" data-type="user">å‚ä¸è€…ç™»å½•</div>
                <div class="user-type" data-type="admin">å·¥ä½œäººå‘˜ç™»å½•</div>
            </div>
            
            <div class="form-group">
                <label for="username">å§“å</label>
                <input type="text" id="username" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            </div>
            
            <!-- å·¥ä½œäººå‘˜å¯†ç è¾“å…¥åŒºåŸŸ -->
            <div class="form-group" id="adminPasswordContainer" style="display: none;">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            
            <!-- æ¤ç‰©é€‰æ‹©åŒºåŸŸ - æ–°ç”¨æˆ·ä½¿ç”¨ -->
            <div class="form-group" id="plantSelectContainer" style="display: none;">
                <label for="plantSelect">é€‰æ‹©è®¤å…»æ¤ç‰©</label>
                <select id="plantSelect" class="form-control">
                    <option value="">è¯·é€‰æ‹©æ‚¨è®¤å…»çš„æ¤ç‰©</option>
                    <!-- æ¤ç‰©é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
            
            <!-- å·²ç»‘å®šæ¤ç‰©ä¿¡æ¯ - è€ç”¨æˆ·ä½¿ç”¨ -->
            <div class="user-bound-info" id="loginUserBoundInfo" style="display: none;">
                <div class="welcome-message">æ¬¢è¿å›æ¥ï¼æ‚¨å·²ç»‘å®šæ¤ç‰©ï¼š</div>
                <div class="bound-plant" id="boundPlantName">æ¤ç‰©åç§° #ç¼–å·</div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" id="loginButton">ç™»å½•</button>
        </div>
    </div>

    <!-- å‰å°ç”¨æˆ·ç•Œé¢ -->
    <div class="frontend container" id="frontendPage" style="display: none;">
        <div class="header">
            <h1>æµ‡ä¸ªç›†å‹</h1>
            <p>ä¹¦é¦™ä¼´ç»¿æ„ï¼Œé˜…è¯»å…±æˆé•¿</p>
        </div>
        
        <!-- ç”¨æˆ·ç»‘å®šæ¤ç‰©ä¿¡æ¯ -->
        <div class="user-bound-info" id="userBoundInfo" style="display: none;">
            <div class="welcome-message">æ¬¢è¿å›æ¥ï¼Œ<span id="userWelcomeName"></span>ï¼</div>
            <div class="bound-plant">æ‚¨ç…§æ–™çš„æ¤ç‰©ï¼š<span id="userBoundPlant"></span></div>
        </div>
        
        <div class="main-actions">
            <button class="checkin-btn" id="checkinButton">
                ä»Šæ—¥æ‰“å¡
                <span id="todayCheckinIndicator" class="today-checkin-indicator" style="display: none;">ä»Šæ—¥å·²æ‰“å¡</span>
            </button>
            
            <div class="progress-section">
                <h2 class="section-title">æˆ‘çš„æ‰“å¡è¿›åº¦</h2>
                <div class="progress-circle" id="progressCircle">
                    <div class="progress-inner">
                        <div class="progress-days" id="progressDays">0/21</div>
                        <div class="progress-text">å·²æ‰“å¡å¤©æ•°</div>
                    </div>
                </div>
            </div>
            
            <div class="recent-records">
                <h2 class="section-title">æˆ‘çš„æ‰“å¡è®°å½•</h2>
                <div class="record-list" id="recentRecords">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åå°ç®¡ç†ç•Œé¢ -->
    <div class="backend" id="backendPage" style="display: none;">
        <div class="admin-header">
            <h2>æµ‡ä¸ªç›†å‹ - åå°ç®¡ç†ç³»ç»Ÿ</h2>
            <div>
                <span id="adminWelcome">ç®¡ç†å‘˜ï¼Œæ‚¨å¥½ï¼</span>
                <button class="btn btn-secondary" id="logoutButton" style="margin-left: 15px;">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        
        <div class="admin-layout">
            <div class="sidebar">
                <div class="menu-item active" data-section="plantManage">æ¤ç‰©ä¿¡æ¯ç®¡ç†</div>
                <div class="menu-item" data-section="adopterManage">å‚ä¸è€…ç®¡ç†</div>
                <div class="menu-item" data-section="checkinReview">
                    æ‰“å¡å®¡æ ¸
                    <span class="menu-badge" id="pendingCheckinCount">0</span>
                </div>
            </div>
            
            <div class="content-area">
                <!-- æ¤ç‰©ä¿¡æ¯ç®¡ç† -->
                <div id="plantManage" class="content-section">
                    <div class="table-header">
                        <h3>æ¤ç‰©ä¿¡æ¯ç®¡ç†</h3>
                        <button class="btn btn-primary" id="addPlantButton">æ·»åŠ æ¤ç‰©</button>
                    </div>
                    
                    <div class="data-table">
                        <table id="plantTable">
                            <thead>
                                <tr>
                                    <th>æ¤ç‰©ç¼–å·</th>
                                    <th>æ¤ç‰©åç§°</th>
                                    <th>å½“å‰çŠ¶æ€</th>
                                    <th>ç»‘å®šç”¨æˆ·</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- å‚ä¸è€…ç®¡ç† -->
                <div id="adopterManage" class="content-section" style="display: none;">
                    <div class="table-header">
                        <h3>å‚ä¸è€…ç®¡ç†</h3>
                        <button class="btn btn-primary" id="bindAdopterButton">ç»‘å®šæ¤ç‰©</button>
                    </div>
                    
                    <div class="data-table">
                        <table id="adopterTable">
                            <thead>
                                <tr>
                                    <th>å§“å</th>
                                    <th>ç»‘å®šæ¤ç‰©</th>
                                    <th>é¦–æ¬¡æ‰“å¡æ—¥æœŸ</th>
                                    <th>æ‰“å¡å¤©æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ‰“å¡å®¡æ ¸ -->
                <div id="checkinReview" class="content-section" style="display: none;">
                    <div class="table-header">
                        <h3>å¾…å®¡æ ¸æ‰“å¡è®°å½•</h3>
                        <div>
                            <button class="btn btn-primary" id="batchApproveButton">æ‰¹é‡é€šè¿‡</button>
                            <button class="btn btn-secondary" style="margin-left: 10px;" id="batchRejectButton">æ‰¹é‡æ‹’ç»</button>
                        </div>
                    </div>
                    
                    <div class="data-table">
                        <table id="checkinTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>æäº¤æ—¶é—´</th>
                                    <th>å‚ä¸è€…</th>
                                    <th>æ¤ç‰©ä¿¡æ¯</th>
                                    <th>æ‰“å¡æ—¥æœŸ</th>
                                    <th>ç…§ç‰‡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal" id="photoUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¸Šä¼ æ‰“å¡ç…§ç‰‡</h3>
                <button class="close-btn" id="closePhotoUploadModal">&times;</button>
            </div>
            
            <div class="form-group">
                <p>è¯·ä¸Šä¼ ä»Šæ—¥çš„æ¤ç‰©ç…§ç‰‡ä½œä¸ºæ‰“å¡å‡­è¯</p>
            </div>
            
            <div class="photo-upload-area" id="photoUploadArea">
                <div>
                    <i>ğŸ“·</i>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°è¿™é‡Œ</p>
                    <p class="file-size-warning" id="fileSizeWarning">ç…§ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB</p>
                </div>
                <input type="file" id="photoUpload" accept="image/*" style="display: none;">
            </div>
            
            <div class="photo-preview-container">
                <img id="photoPreview" class="photo-preview" alt="ç…§ç‰‡é¢„è§ˆ">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" id="cancelPhotoButton">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="submitPhotoButton" disabled>æäº¤æ‰“å¡</button>
            </div>
        </div>
    </div>

    <!-- ç»‘å®šæ¤ç‰©æ¨¡æ€æ¡† -->
    <div class="modal" id="bindPlantModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç»‘å®šæ¤ç‰©</h3>
                <button class="close-btn" id="closeBindPlantModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="bindAdopterName">å‚ä¸è€…å§“å</label>
                <select id="bindAdopterName" class="form-control">
                    <option value="">è¯·é€‰æ‹©å‚ä¸è€…</option>
                </select>
            </div>
            <div class="form-group">
                <label for="bindPlantAdmin">ç»‘å®šæ¤ç‰©</label>
                <select id="bindPlantAdmin" class="form-control">
                    <option value="">è¯·é€‰æ‹©æ¤ç‰©</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="cancelBindPlant">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveBindPlantButton">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æ¤ç‰©æ¨¡æ€æ¡† -->
    <div class="modal" id="addPlantModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æ¤ç‰©</h3>
                <button class="close-btn" id="closeAddPlantModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="plantId">æ¤ç‰©ç¼–å·</label>
                <input type="text" id="plantId" class="form-control" placeholder="è¯·è¾“å…¥æ¤ç‰©ç¼–å·">
            </div>
            <div class="form-group">
                <label for="plantName">æ¤ç‰©åç§°</label>
                <input type="text" id="plantName" class="form-control" placeholder="è¯·è¾“å…¥æ¤ç‰©åç§°">
            </div>
            <div class="form-group">
                <label for="plantDescription">æ¤ç‰©æè¿°</label>
                <textarea id="plantDescription" class="form-control" placeholder="è¯·è¾“å…¥æ¤ç‰©æè¿°ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="cancelAddPlant">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="savePlantButton">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://xusjjspbwxnmrcwftaqt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1c2pqc3Bid3hubXJjd2Z0YXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NjI4MDksImV4cCI6MjA3ODMzODgwOX0.IqVotyCUMA4y-Fp4TN-WmTgZfw1fUMc_EG4kebsHWbQ';
        
        // å…¨å±€å˜é‡
        let supabase = null;
        let currentUser = null;
        let plants = [];
        let adopters = [];
        let checkins = [];
        let currentPhotoData = null;
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(isConnected) {
            const statusIndicator = document.getElementById('statusIndicator');
            if (isConnected) {
                statusIndicator.textContent = 'æ•°æ®åº“å·²è¿æ¥';
                statusIndicator.className = 'status-indicator status-connected';
            } else {
                statusIndicator.textContent = 'æ•°æ®åº“æœªè¿æ¥';
                statusIndicator.className = 'status-indicator status-disconnected';
            }
        }
        
        // è·å–åŒ—äº¬æ—¶é—´
        function getBeijingTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const beijingTime = new Date(utc + (3600000 * 8));
            return beijingTime;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ä»SupabaseåŠ è½½æ•°æ®
        async function loadData() {
            try {
                // åŠ è½½æ¤ç‰©æ•°æ®
                const { data: plantsData, error: plantsError } = await supabase
                    .from('plants')
                    .select('*')
                    .order('id');
                
                if (plantsError) throw plantsError;
                plants = plantsData || [];
                
                // åŠ è½½å‚ä¸è€…æ•°æ®
                const { data: adoptersData, error: adoptersError } = await supabase
                    .from('adopters')
                    .select('*');
                
                if (adoptersError) {
                    console.error('åŠ è½½å‚ä¸è€…é”™è¯¯:', adoptersError);
                    adopters = [];
                } else {
                    adopters = adoptersData || [];
                }
                
                // åŠ è½½æ‰“å¡è®°å½•
                const { data: checkinsData, error: checkinsError } = await supabase
                    .from('checkins')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('time', { ascending: false });
                
                if (checkinsError) throw checkinsError;
                checkins = checkinsData || [];
                
                // æ›´æ–°å‰ç«¯æ˜¾ç¤º
                updateLoginPlantSelect();
                updateAdminPlantSelect();
                updateAdopterSelect();
                renderPlantTable();
                renderAdopterTable();
                renderCheckinTable();
                
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
                showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                updateConnectionStatus(false);
                return false;
            }
        }
        
        // åˆå§‹åŒ–æ•°æ®
        async function initializeData() {
            const success = await loadData();
            if (!success) {
                document.getElementById('errorMessage').textContent = 'æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }
        
        // æ›´æ–°ç™»å½•é¡µé¢æ¤ç‰©é€‰æ‹©ä¸‹æ‹‰èœå•
        function updateLoginPlantSelect() {
            const plantSelect = document.getElementById('plantSelect');
            
            if (plantSelect) {
                plantSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‚¨è®¤å…»çš„æ¤ç‰©</option>';
                
                plants.forEach(plant => {
                    // æ£€æŸ¥æ¤ç‰©æ˜¯å¦å·²è¢«ç»‘å®š
                    const isBound = adopters.some(adopter => adopter.plant_id === plant.id);
                    
                    if (!isBound) {
                        const option = document.createElement('option');
                        option.value = plant.id;
                        option.textContent = `${plant.name} #${plant.id}`;
                        plantSelect.appendChild(option);
                    }
                });
            }
        }
        
        // æ›´æ–°æ¤ç‰©é€‰æ‹©ä¸‹æ‹‰èœå•ï¼ˆç®¡ç†å‘˜ç•Œé¢ï¼‰
        function updateAdminPlantSelect() {
            const bindPlantAdmin = document.getElementById('bindPlantAdmin');
            
            if (bindPlantAdmin) {
                bindPlantAdmin.innerHTML = '<option value="">è¯·é€‰æ‹©æ¤ç‰©</option>';
                
                plants.forEach(plant => {
                    // æ£€æŸ¥æ¤ç‰©æ˜¯å¦å·²è¢«ç»‘å®š
                    const isBound = adopters.some(adopter => adopter.plant_id === plant.id);
                    
                    if (!isBound) {
                        const option = document.createElement('option');
                        option.value = plant.id;
                        option.textContent = `${plant.name} #${plant.id}`;
                        bindPlantAdmin.appendChild(option);
                    }
                });
            }
        }
        
        // æ›´æ–°å‚ä¸è€…é€‰æ‹©ä¸‹æ‹‰èœå•
        function updateAdopterSelect() {
            const bindAdopterName = document.getElementById('bindAdopterName');
            
            if (bindAdopterName) {
                bindAdopterName.innerHTML = '<option value="">è¯·é€‰æ‹©å‚ä¸è€…</option>';
                
                adopters.forEach(adopter => {
                    // åªæ˜¾ç¤ºæœªç»‘å®šæ¤ç‰©çš„å‚ä¸è€…
                    if (!adopter.plant_id) {
                        const option = document.createElement('option');
                        option.value = adopter.name;
                        option.textContent = adopter.name;
                        bindAdopterName.appendChild(option);
                    }
                });
            }
        }
        
        // æ¸²æŸ“æ¤ç‰©è¡¨æ ¼
        function renderPlantTable() {
            const tbody = document.querySelector('#plantTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (plants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-records">æš‚æ— æ¤ç‰©æ•°æ®</td></tr>';
                return;
            }
            
            plants.forEach(plant => {
                // æŸ¥æ‰¾ç»‘å®šæ­¤æ¤ç‰©çš„å‚ä¸è€…
                const adopter = adopters.find(a => a.plant_id === plant.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${plant.id}</td>
                    <td>${plant.name}</td>
                    <td>${adopter ? 'å·²è¢«è®¤å…»' : 'å¾…è®¤å…»'}</td>
                    <td>${adopter ? adopter.name : '-'}</td>
                    <td>
                        <button class="btn btn-warning delete-plant" data-plant-id="${plant.id}">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ¸²æŸ“å‚ä¸è€…è¡¨æ ¼
        function renderAdopterTable() {
            const tbody = document.querySelector('#adopterTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (adopters.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-records">æš‚æ— å‚ä¸è€…æ•°æ®</td></tr>';
                return;
            }
            
            adopters.forEach(adopter => {
                const plant = plants.find(p => p.id === adopter.plant_id);
                const plantName = plant ? `${plant.name} #${plant.id}` : 'æœªç»‘å®šæ¤ç‰©';
                
                // è®¡ç®—ç”¨æˆ·çš„æ‰“å¡å¤©æ•°
                const userCheckins = checkins.filter(
                    checkin => checkin.student_id === adopter.name && checkin.status === 'approved'
                );
                const uniqueDates = [...new Set(userCheckins.map(checkin => checkin.date))];
                const checkinDays = uniqueDates.length;
                
                // è®¡ç®—é¦–æ¬¡æ‰“å¡æ—¥æœŸ
                let firstCheckinDate = 'æš‚æ— ';
                if (userCheckins.length > 0) {
                    const sortedDates = userCheckins.map(c => c.date).sort();
                    firstCheckinDate = sortedDates[0];
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${adopter.name}</td>
                    <td>${plantName}</td>
                    <td>${firstCheckinDate}</td>
                    <td>${checkinDays}å¤©</td>
                    <td>
                        <button class="btn btn-warning delete-adopter" data-adopter-name="${adopter.name}">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ¸²æŸ“æ‰“å¡è¡¨æ ¼
        function renderCheckinTable() {
            const tbody = document.querySelector('#checkinTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // è·å–å¾…å®¡æ ¸çš„æ‰“å¡è®°å½•
            const pendingCheckins = checkins.filter(checkin => checkin.status === 'pending');
            
            if (pendingCheckins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-records">æš‚æ— å¾…å®¡æ ¸çš„æ‰“å¡è®°å½•</td></tr>';
                document.getElementById('pendingCheckinCount').textContent = '0';
                return;
            }
            
            pendingCheckins.forEach((checkin) => {
                const adopter = adopters.find(a => a.name === checkin.student_id);
                const plant = plants.find(p => p.id === checkin.plant_id);
                
                if (adopter && plant) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="record-checkbox" data-checkin-id="${checkin.id}"></td>
                        <td>${checkin.date} ${checkin.time}</td>
                        <td>${adopter.name}</td>
                        <td>${plant.name} #${plant.id}</td>
                        <td>${checkin.date}</td>
                        <td>
                            ${checkin.photo ? 
                                `<button class="btn btn-secondary view-photo" data-photo="${checkin.photo}">æŸ¥çœ‹ç…§ç‰‡</button>` : 
                                'æ— ç…§ç‰‡'}
                        </td>
                        <td>
                            <button class="btn btn-primary approve-checkin" data-checkin-id="${checkin.id}">é€šè¿‡</button>
                            <button class="btn btn-warning reject-checkin" style="margin-left: 5px;" data-checkin-id="${checkin.id}">æ‹’ç»</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
            
            document.getElementById('pendingCheckinCount').textContent = pendingCheckins.length;
        }
        
        // æ›´æ–°ç”¨æˆ·æ‰“å¡è¿›åº¦
        function updateUserProgress() {
            if (!currentUser) return;
            
            // è·å–ç”¨æˆ·çš„æ‰€æœ‰æ‰“å¡è®°å½•
            const userCheckins = checkins.filter(
                checkin => checkin.student_id === currentUser.username && checkin.status === 'approved'
            );
            
            // è®¡ç®—å·²æ‰“å¡å¤©æ•°ï¼ˆå»é‡ï¼‰
            const uniqueDates = [...new Set(userCheckins.map(checkin => checkin.date))];
            const checkinDays = uniqueDates.length;
            const targetDays = 21;
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            document.getElementById('progressDays').textContent = `${checkinDays}/${targetDays}`;
            
            // æ›´æ–°è¿›åº¦ç¯
            const progressCircle = document.getElementById('progressCircle');
            const progressPercentage = (checkinDays / targetDays) * 100;
            progressCircle.style.background = `conic-gradient(var(--primary-green) 0% ${progressPercentage}%, var(--border-gray) ${progressPercentage}% 100%)`;
            
            // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
            const today = formatDate(getBeijingTime());
            const todayCheckin = userCheckins.find(checkin => checkin.date === today);
            const todayCheckinIndicator = document.getElementById('todayCheckinIndicator');
            const checkinButton = document.getElementById('checkinButton');
            
            if (todayCheckin) {
                todayCheckinIndicator.style.display = 'inline';
                checkinButton.disabled = true;
                checkinButton.innerHTML = 'ä»Šæ—¥å·²æ‰“å¡ <span id="todayCheckinIndicator" class="today-checkin-indicator" style="display: inline;">ä»Šæ—¥å·²æ‰“å¡</span>';
            } else {
                todayCheckinIndicator.style.display = 'none';
                checkinButton.disabled = false;
                checkinButton.innerHTML = 'ä»Šæ—¥æ‰“å¡ <span id="todayCheckinIndicator" class="today-checkin-indicator" style="display: none;">ä»Šæ—¥å·²æ‰“å¡</span>';
            }
            
            // æ›´æ–°æ‰“å¡è®°å½•
            updateRecentRecords();
        }
        
        // æ›´æ–°æ‰“å¡è®°å½•
        function updateRecentRecords() {
            if (!currentUser) return;
            
            const recentRecords = document.getElementById('recentRecords');
            if (!recentRecords) return;
            
            recentRecords.innerHTML = '';
            
            // è·å–ç”¨æˆ·çš„æ‰€æœ‰æ‰“å¡è®°å½•ï¼ˆå·²å®¡æ ¸çš„ï¼‰
            const userCheckins = checkins.filter(
                checkin => checkin.student_id === currentUser.username && checkin.status === 'approved'
            );
            
            if (userCheckins.length === 0) {
                recentRecords.innerHTML = '<div class="no-records">æš‚æ— æ‰“å¡è®°å½•</div>';
                return;
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰æ‰“å¡è®°å½•
            userCheckins.forEach(checkin => {
                const plant = plants.find(p => p.id === checkin.plant_id);
                const plantName = plant ? `${plant.name} #${plant.id}` : 'æœªçŸ¥æ¤ç‰©';
                
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                recordItem.innerHTML = `
                    <span>${checkin.date} ${checkin.time}</span>
                    <span>${plantName}</span>
                `;
                recentRecords.appendChild(recordItem);
            });
        }
        
        // ç™»å½•åŠŸèƒ½
        async function login() {
            const username = document.getElementById('username').value.trim();
            const userType = document.querySelector('.user-type.active').dataset.type;
            
            if (!username) {
                showError('è¯·è¾“å…¥å§“å');
                return;
            }
            
            // å·¥ä½œäººå‘˜è´¦å·éªŒè¯
            if (userType === 'admin') {
                const password = document.getElementById('password').value;
                if (username === 'zrt' && password === '123456') {
                    currentUser = {
                        username: username,
                        type: userType
                    };
                    
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('backendPage').style.display = 'block';
                    document.getElementById('adminWelcome').textContent = username + 'ï¼Œæ‚¨å¥½ï¼';
                    return;
                } else {
                    showError('å·¥ä½œäººå‘˜è´¦å·æˆ–å¯†ç é”™è¯¯');
                    return;
                }
            }
            
            // æ™®é€šç”¨æˆ·ç™»å½• - æ— éœ€å¯†ç 
            if (userType === 'user') {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                let adopter = adopters.find(a => a.name === username);
                const selectedPlantId = document.getElementById('plantSelect').value;
                
                if (!adopter) {
                    // æ–°ç”¨æˆ·å¿…é¡»é€‰æ‹©æ¤ç‰©
                    if (!selectedPlantId) {
                        showError('è¯·é€‰æ‹©è¦è®¤å…»çš„æ¤ç‰©');
                        return;
                    }
                    
                    // åˆ›å»ºæ–°ç”¨æˆ·
                    try {
                        const { data, error } = await supabase
                            .from('adopters')
                            .insert([{ 
                                name: username,
                                plant_id: selectedPlantId
                            }])
                            .select();
                        
                        if (error) {
                            console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', error);
                            showError('è‡ªåŠ¨åˆ›å»ºç”¨æˆ·å¤±è´¥: ' + error.message);
                            return;
                        }
                        
                        // æ·»åŠ åˆ°æœ¬åœ°æ•°ç»„
                        if (data && data.length > 0) {
                            adopters.push(data[0]);
                            adopter = data[0];
                        } else {
                            const newAdopter = { name: username, plant_id: selectedPlantId };
                            adopters.push(newAdopter);
                            adopter = newAdopter;
                        }
                        
                        // æ›´æ–°æ¤ç‰©çŠ¶æ€
                        await updatePlantStatus(selectedPlantId, username);
                        
                        // æ›´æ–°ç®¡ç†å‘˜ç•Œé¢
                        updateAdminPlantSelect();
                        updateAdopterSelect();
                        renderPlantTable();
                        renderAdopterTable();
                    } catch (error) {
                        console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', error);
                        showError('è‡ªåŠ¨åˆ›å»ºç”¨æˆ·å¤±è´¥: ' + error.message);
                        return;
                    }
                } else {
                    // è€ç”¨æˆ·ï¼Œä¸åº”è¯¥é€‰æ‹©æ¤ç‰©
                    if (selectedPlantId && selectedPlantId !== adopter.plant_id) {
                        showError('æ‚¨å·²ç»‘å®šæ¤ç‰©ï¼Œä¸èƒ½é‡æ–°é€‰æ‹©');
                        return;
                    }
                }
                
                // è®¾ç½®å½“å‰ç”¨æˆ·
                currentUser = {
                    username: username,
                    type: userType,
                    plantId: adopter.plant_id,
                    plantName: null
                };
                
                // è·å–æ¤ç‰©åç§°
                if (adopter.plant_id) {
                    const plant = plants.find(p => p.id === adopter.plant_id);
                    if (plant) {
                        currentUser.plantName = plant.name;
                        
                        // æ˜¾ç¤ºç”¨æˆ·ç»‘å®šä¿¡æ¯
                        document.getElementById('userWelcomeName').textContent = username;
                        document.getElementById('userBoundPlant').textContent = `${plant.name} #${plant.id}`;
                        document.getElementById('userBoundInfo').style.display = 'block';
                    }
                }
                
                // æ›´æ–°ç•Œé¢
                updateUserProgress();
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('frontendPage').style.display = 'block';
            }
        }
        
        // ç®¡ç†å‘˜ç»‘å®šæ¤ç‰©
        async function bindPlantAdmin() {
            const adopterName = document.getElementById('bindAdopterName').value;
            const plantId = document.getElementById('bindPlantAdmin').value;
            
            if (!adopterName || !plantId) {
                showError('è¯·é€‰æ‹©å‚ä¸è€…å’Œæ¤ç‰©');
                return;
            }
            
            try {
                // æ›´æ–°æ•°æ®åº“
                const { error } = await supabase
                    .from('adopters')
                    .update({ plant_id: plantId })
                    .eq('name', adopterName);
                
                if (error) {
                    console.error('ç»‘å®šæ¤ç‰©é”™è¯¯:', error);
                    showError('ç»‘å®šæ¤ç‰©å¤±è´¥: ' + error.message);
                    return;
                }
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const adopterIndex = adopters.findIndex(a => a.name === adopterName);
                if (adopterIndex !== -1) {
                    adopters[adopterIndex].plant_id = plantId;
                }
                
                // æ›´æ–°æ¤ç‰©çŠ¶æ€
                await updatePlantStatus(plantId, adopterName);
                
                // æ›´æ–°ç•Œé¢
                closeBindPlantModal();
                updateAdminPlantSelect();
                updateAdopterSelect();
                renderPlantTable();
                renderAdopterTable();
                
                alert('æ¤ç‰©ç»‘å®šæˆåŠŸï¼');
            } catch (error) {
                console.error('ç»‘å®šæ¤ç‰©é”™è¯¯:', error);
                showError('ç»‘å®šæ¤ç‰©å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°æ¤ç‰©çŠ¶æ€
        async function updatePlantStatus(plantId, adopterName) {
            // æ›´æ–°æ•°æ®åº“ä¸­çš„æ¤ç‰©çŠ¶æ€
            const { error } = await supabase
                .from('plants')
                .update({
                    status: 'å·²è¢«è®¤å…»',
                    bound_user: adopterName
                })
                .eq('id', plantId);
            
            if (error) {
                console.error('æ›´æ–°æ¤ç‰©çŠ¶æ€é”™è¯¯:', error);
            }
            
            // é‡æ–°åŠ è½½æ•°æ®ä»¥ç¡®ä¿åŒæ­¥
            await loadData();
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            currentUser = null;
            document.getElementById('frontendPage').style.display = 'none';
            document.getElementById('backendPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            
            // é‡ç½®è¡¨å•
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('plantSelect').value = '';
            
            // é‡ç½®ç™»å½•ç•Œé¢æ˜¾ç¤º
            document.getElementById('plantSelectContainer').style.display = 'none';
            document.getElementById('loginUserBoundInfo').style.display = 'none';
            document.getElementById('adminPasswordContainer').style.display = 'none';
        }
        
        // åå°èœå•åˆ‡æ¢
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).style.display = 'block';
            event.target.classList.add('active');
        }
        
        // æ‰“å¼€ç»‘å®šæ¤ç‰©æ¨¡æ€æ¡†ï¼ˆç®¡ç†å‘˜ï¼‰
        function openBindPlantModal() {
            document.getElementById('bindPlantModal').style.display = 'flex';
        }
        
        // å…³é—­ç»‘å®šæ¤ç‰©æ¨¡æ€æ¡†
        function closeBindPlantModal() {
            document.getElementById('bindPlantModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('bindAdopterName').value = '';
            document.getElementById('bindPlantAdmin').value = '';
        }
        
        // æ‰“å¼€æ·»åŠ æ¤ç‰©æ¨¡æ€æ¡†
        function openAddPlantModal() {
            document.getElementById('addPlantModal').style.display = 'flex';
        }
        
        // å…³é—­æ·»åŠ æ¤ç‰©æ¨¡æ€æ¡†
        function closeAddPlantModal() {
            document.getElementById('addPlantModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('plantId').value = '';
            document.getElementById('plantName').value = '';
            document.getElementById('plantDescription').value = '';
        }
        
        // æ·»åŠ æ¤ç‰©
        async function addPlant() {
            const plantId = document.getElementById('plantId').value;
            const plantName = document.getElementById('plantName').value;
            const plantDescription = document.getElementById('plantDescription').value;
            
            if (!plantId || !plantName) {
                showError('è¯·å¡«å†™æ¤ç‰©ç¼–å·å’Œåç§°');
                return;
            }
            
            // æ£€æŸ¥æ¤ç‰©IDæ˜¯å¦å·²å­˜åœ¨
            if (plants.some(plant => plant.id === plantId)) {
                showError('æ¤ç‰©ç¼–å·å·²å­˜åœ¨');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('plants')
                    .insert([{
                        id: plantId,
                        name: plantName,
                        description: plantDescription,
                        status: 'å¾…è®¤å…»'
                    }]);
                
                if (error) {
                    console.error('æ·»åŠ æ¤ç‰©é”™è¯¯:', error);
                    showError('æ·»åŠ æ¤ç‰©å¤±è´¥: ' + error.message);
                    return;
                }
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadData();
                closeAddPlantModal();
                alert('æ¤ç‰©æ·»åŠ æˆåŠŸï¼');
            } catch (error) {
                console.error('æ·»åŠ æ¤ç‰©é”™è¯¯:', error);
                showError('æ·»åŠ æ¤ç‰©å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤æ¤ç‰©
        async function deletePlant(plantId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¤ç‰©å—ï¼Ÿ')) return;
            
            // æ£€æŸ¥æ¤ç‰©æ˜¯å¦å·²è¢«ç»‘å®š
            const adopter = adopters.find(a => a.plant_id === plantId);
            if (adopter) {
                showError('è¯¥æ¤ç‰©å·²è¢«ç»‘å®šï¼Œæ— æ³•åˆ é™¤');
                return;
            }
            
            const { error } = await supabase
                .from('plants')
                .delete()
                .eq('id', plantId);
            
            if (error) {
                console.error('åˆ é™¤æ¤ç‰©é”™è¯¯:', error);
                showError('åˆ é™¤æ¤ç‰©å¤±è´¥');
                return;
            }
            
            // é‡æ–°åŠ è½½æ•°æ®
            await loadData();
            alert('æ¤ç‰©åˆ é™¤æˆåŠŸ');
        }
        
        // åˆ é™¤å‚ä¸è€…
        async function deleteAdopter(adopterName) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‚ä¸è€…å—ï¼Ÿ')) return;
            
            const adopter = adopters.find(a => a.name === adopterName);
            
            const { error } = await supabase
                .from('adopters')
                .delete()
                .eq('name', adopterName);
            
            if (error) {
                console.error('åˆ é™¤å‚ä¸è€…é”™è¯¯:', error);
                showError('åˆ é™¤å‚ä¸è€…å¤±è´¥');
                return;
            }
            
            // ä»æœ¬åœ°æ•°ç»„ç§»é™¤
            adopters = adopters.filter(a => a.name !== adopterName);
            
            // å¦‚æœå‚ä¸è€…ç»‘å®šäº†æ¤ç‰©ï¼Œæ›´æ–°æ¤ç‰©çŠ¶æ€
            if (adopter && adopter.plant_id) {
                const { error: plantError } = await supabase
                    .from('plants')
                    .update({
                        status: 'å¾…è®¤å…»',
                        bound_user: ''
                    })
                    .eq('id', adopter.plant_id);
                
                if (plantError) {
                    console.error('æ›´æ–°æ¤ç‰©çŠ¶æ€é”™è¯¯:', plantError);
                }
            }
            
            // é‡æ–°åŠ è½½æ•°æ®ä»¥ç¡®ä¿åŒæ­¥
            await loadData();
            
            alert('å‚ä¸è€…åˆ é™¤æˆåŠŸ');
        }
        
        // æ‰“å¼€ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†
        function openPhotoUploadModal() {
            document.getElementById('photoUploadModal').style.display = 'flex';
            resetPhotoUploadModal();
        }
        
        // å…³é—­ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†
        function closePhotoUploadModal() {
            document.getElementById('photoUploadModal').style.display = 'none';
            resetPhotoUploadModal();
        }
        
        // é‡ç½®ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†
        function resetPhotoUploadModal() {
            currentPhotoData = null;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('submitPhotoButton').disabled = true;
            document.getElementById('fileSizeWarning').style.display = 'none';
            document.getElementById('photoUpload').value = '';
        }
        
        // å¤„ç†ç…§ç‰‡ä¸Šä¼ 
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å° (2MB)
            if (file.size > 2 * 1024 * 1024) {
                document.getElementById('fileSizeWarning').style.display = 'block';
                document.getElementById('submitPhotoButton').disabled = true;
                return;
            } else {
                document.getElementById('fileSizeWarning').style.display = 'none';
            }
            
            // è¯»å–æ–‡ä»¶ä¸ºDataURL
            const reader = new FileReader();
            reader.onload = function(e) {
                currentPhotoData = e.target.result;
                
                // æ˜¾ç¤ºç…§ç‰‡é¢„è§ˆ
                const photoPreview = document.getElementById('photoPreview');
                photoPreview.src = currentPhotoData;
                photoPreview.style.display = 'block';
                
                // å¯ç”¨æäº¤æŒ‰é’®
                document.getElementById('submitPhotoButton').disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        // æäº¤æ‰“å¡ï¼ˆå¸¦ç…§ç‰‡ï¼‰
        async function submitCheckinWithPhoto() {
            if (!currentUser || !currentUser.plantId) {
                showError('æ‚¨å°šæœªç»‘å®šæ¤ç‰©ï¼Œæ— æ³•æ‰“å¡');
                return;
            }
            
            if (!currentPhotoData) {
                showError('è¯·ä¸Šä¼ ç…§ç‰‡');
                return;
            }
            
            // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
            const today = formatDate(getBeijingTime());
            const userCheckins = checkins.filter(
                checkin => checkin.student_id === currentUser.username && checkin.status === 'approved'
            );
            const todayCheckin = userCheckins.find(checkin => checkin.date === today);
            
            if (todayCheckin) {
                showError('ä»Šæ—¥å·²æ‰“å¡ï¼Œè¯·å‹¿é‡å¤æ‰“å¡');
                closePhotoUploadModal();
                return;
            }
            
            // åˆ›å»ºæ–°çš„æ‰“å¡è®°å½•
            const beijingTime = getBeijingTime();
            const date = formatDate(beijingTime);
            const time = beijingTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            const newCheckin = {
                student_id: currentUser.username,
                plant_id: currentUser.plantId,
                date: date,
                time: time,
                photo: currentPhotoData,
                status: 'pending'
            };
            
            try {
                // æ·»åŠ åˆ°æ•°æ®åº“
                const { data, error } = await supabase
                    .from('checkins')
                    .insert([newCheckin])
                    .select();
                
                if (error) {
                    console.error('æ·»åŠ æ‰“å¡è®°å½•é”™è¯¯:', error);
                    showError('æäº¤æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
                    return;
                }
                
                // æ·»åŠ åˆ°æœ¬åœ°æ•°ç»„
                if (data && data.length > 0) {
                    checkins.push(data[0]);
                } else {
                    checkins.push(newCheckin);
                }
                
                // æ›´æ–°åå°æ•°æ®
                renderCheckinTable();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert('æ‰“å¡æäº¤æˆåŠŸï¼Œç­‰å¾…å®¡æ ¸ï¼');
                
                // å…³é—­ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†
                closePhotoUploadModal();
                
                // é‡æ–°åŠ è½½æ•°æ®ä»¥ç¡®ä¿åŒæ­¥
                await loadData();
                
                // æ›´æ–°ç”¨æˆ·è¿›åº¦
                updateUserProgress();
            } catch (error) {
                console.error('æäº¤æ‰“å¡é”™è¯¯:', error);
                showError('æäº¤æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
            }
        }
        
        // å®¡æ ¸é€šè¿‡æ‰“å¡
        async function approveCheckin(checkinId) {
            const { error } = await supabase
                .from('checkins')
                .update({ status: 'approved' })
                .eq('id', checkinId);
            
            if (error) {
                console.error('å®¡æ ¸é€šè¿‡é”™è¯¯:', error);
                showError('å®¡æ ¸æ“ä½œå¤±è´¥');
                return;
            }
            
            // æ›´æ–°æœ¬åœ°æ•°ç»„
            const checkinIndex = checkins.findIndex(c => c.id === checkinId);
            if (checkinIndex !== -1) {
                checkins[checkinIndex].status = 'approved';
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderCheckinTable();
            alert('æ‰“å¡è®°å½•å·²é€šè¿‡å®¡æ ¸');
        }
        
        // å®¡æ ¸æ‹’ç»æ‰“å¡
        async function rejectCheckin(checkinId) {
            const { error } = await supabase
                .from('checkins')
                .update({ status: 'rejected' })
                .eq('id', checkinId);
            
            if (error) {
                console.error('å®¡æ ¸æ‹’ç»é”™è¯¯:', error);
                showError('å®¡æ ¸æ“ä½œå¤±è´¥');
                return;
            }
            
            // æ›´æ–°æœ¬åœ°æ•°ç»„
            const checkinIndex = checkins.findIndex(c => c.id === checkinId);
            if (checkinIndex !== -1) {
                checkins[checkinIndex].status = 'rejected';
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderCheckinTable();
            alert('æ‰“å¡è®°å½•å·²æ‹’ç»');
        }
        
        // ç”¨æˆ·ç±»å‹åˆ‡æ¢
        function handleUserTypeChange() {
            const userType = document.querySelector('.user-type.active').dataset.type;
            const plantSelectContainer = document.getElementById('plantSelectContainer');
            const loginUserBoundInfo = document.getElementById('loginUserBoundInfo');
            const adminPasswordContainer = document.getElementById('adminPasswordContainer');
            
            // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
            plantSelectContainer.style.display = 'none';
            loginUserBoundInfo.style.display = 'none';
            adminPasswordContainer.style.display = 'none';
            
            // æ¸…ç©ºç”¨æˆ·åå’Œå¯†ç 
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            if (userType === 'admin') {
                // ç®¡ç†å‘˜éœ€è¦å¯†ç 
                adminPasswordContainer.style.display = 'block';
            } else {
                // å‚ä¸è€…ä¸éœ€è¦å¯†ç 
                adminPasswordContainer.style.display = 'none';
            }
        }
        
        // ç”¨æˆ·åè¾“å…¥äº‹ä»¶ - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»‘å®šæ¤ç‰©
        function handleUsernameInput() {
            const userType = document.querySelector('.user-type.active').dataset.type;
            const username = document.getElementById('username').value.trim();
            const plantSelectContainer = document.getElementById('plantSelectContainer');
            const loginUserBoundInfo = document.getElementById('loginUserBoundInfo');
            const boundPlantName = document.getElementById('boundPlantName');
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºæ¤ç‰©ç›¸å…³é€‰é¡¹
            if (userType === 'admin') {
                plantSelectContainer.style.display = 'none';
                loginUserBoundInfo.style.display = 'none';
                return;
            }
            
            // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
            plantSelectContainer.style.display = 'none';
            loginUserBoundInfo.style.display = 'none';
            
            if (username) {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                const adopter = adopters.find(a => a.name === username);
                
                if (adopter) {
                    // è€ç”¨æˆ· - æ˜¾ç¤ºå·²ç»‘å®šæ¤ç‰©ä¿¡æ¯
                    if (adopter.plant_id) {
                        const plant = plants.find(p => p.id === adopter.plant_id);
                        if (plant) {
                            boundPlantName.textContent = `${plant.name} #${plant.id}`;
                            loginUserBoundInfo.style.display = 'block';
                        }
                    } else {
                        // è€ç”¨æˆ·ä½†æœªç»‘å®šæ¤ç‰© - æ˜¾ç¤ºæ¤ç‰©é€‰æ‹©
                        plantSelectContainer.style.display = 'block';
                    }
                } else {
                    // æ–°ç”¨æˆ· - æ˜¾ç¤ºæ¤ç‰©é€‰æ‹©
                    plantSelectContainer.style.display = 'block';
                }
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            console.log('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
            
            // ç”¨æˆ·ç±»å‹é€‰æ‹©
            document.querySelectorAll('.user-type').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.user-type').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    handleUserTypeChange();
                });
            });
            
            // ç”¨æˆ·åè¾“å…¥äº‹ä»¶
            document.getElementById('username').addEventListener('input', handleUsernameInput);
            
            // ç™»å½•æŒ‰é’®
            document.getElementById('loginButton').addEventListener('click', login);
            
            // é€€å‡ºç™»å½•æŒ‰é’®
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // åå°èœå•
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            
            // æ·»åŠ æ¤ç‰©æŒ‰é’®
            document.getElementById('addPlantButton').addEventListener('click', openAddPlantModal);
            
            // å…³é—­æ·»åŠ æ¤ç‰©æ¨¡æ€æ¡†
            document.getElementById('closeAddPlantModal').addEventListener('click', closeAddPlantModal);
            document.getElementById('cancelAddPlant').addEventListener('click', closeAddPlantModal);
            
            // ä¿å­˜æ¤ç‰©æŒ‰é’®
            document.getElementById('savePlantButton').addEventListener('click', addPlant);
            
            // ç®¡ç†å‘˜ç»‘å®šæ¤ç‰©æŒ‰é’®
            document.getElementById('bindAdopterButton').addEventListener('click', openBindPlantModal);
            
            // å…³é—­ç»‘å®šæ¤ç‰©æ¨¡æ€æ¡†
            document.getElementById('closeBindPlantModal').addEventListener('click', closeBindPlantModal);
            document.getElementById('cancelBindPlant').addEventListener('click', closeBindPlantModal);
            
            // ä¿å­˜ç»‘å®šæ¤ç‰©æŒ‰é’®
            document.getElementById('saveBindPlantButton').addEventListener('click', bindPlantAdmin);
            
            // æ‰“å¡æŒ‰é’® - æ”¹ä¸ºæ‰“å¼€ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†
            document.getElementById('checkinButton').addEventListener('click', openPhotoUploadModal);
            
            // ç…§ç‰‡ä¸Šä¼ æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('closePhotoUploadModal').addEventListener('click', closePhotoUploadModal);
            document.getElementById('cancelPhotoButton').addEventListener('click', closePhotoUploadModal);
            document.getElementById('submitPhotoButton').addEventListener('click', submitCheckinWithPhoto);
            document.getElementById('photoUpload').addEventListener('change', handlePhotoUpload);
            
            // ç…§ç‰‡ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            document.getElementById('photoUploadArea').addEventListener('click', function() {
                document.getElementById('photoUpload').click();
            });
            
            // æ‹–æ”¾åŠŸèƒ½
            const photoUploadArea = document.getElementById('photoUploadArea');
            photoUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--primary-green)';
                this.style.backgroundColor = 'var(--light-green)';
            });
            
            photoUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--border-gray)';
                this.style.backgroundColor = 'transparent';
            });
            
            photoUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--border-gray)';
                this.style.backgroundColor = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('photoUpload').files = files;
                    handlePhotoUpload({ target: { files: files } });
                }
            });
            
            // åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®äº‹ä»¶å§”æ‰˜
            document.addEventListener('click', function(e) {
                // åˆ é™¤æ¤ç‰©æŒ‰é’®
                if (e.target.classList.contains('delete-plant')) {
                    const plantId = e.target.getAttribute('data-plant-id');
                    deletePlant(plantId);
                }
                
                // åˆ é™¤å‚ä¸è€…æŒ‰é’®
                if (e.target.classList.contains('delete-adopter')) {
                    const adopterName = e.target.getAttribute('data-adopter-name');
                    deleteAdopter(adopterName);
                }
                
                // å®¡æ ¸é€šè¿‡æ‰“å¡
                if (e.target.classList.contains('approve-checkin')) {
                    const checkinId = e.target.getAttribute('data-checkin-id');
                    approveCheckin(checkinId);
                }
                
                // å®¡æ ¸æ‹’ç»æ‰“å¡
                if (e.target.classList.contains('reject-checkin')) {
                    const checkinId = e.target.getAttribute('data-checkin-id');
                    rejectCheckin(checkinId);
                }
                
                // æŸ¥çœ‹ç…§ç‰‡
                if (e.target.classList.contains('view-photo')) {
                    const photoData = e.target.getAttribute('data-photo');
                    if (photoData) {
                        // åœ¨æ–°çª—å£æ‰“å¼€ç…§ç‰‡
                        const newWindow = window.open();
                        newWindow.document.write(`<img src="${photoData}" style="max-width: 100%;">`);
                    }
                }
            });
            
            console.log('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // åˆå§‹åŒ–Supabase
        function initializeSupabase() {
            console.log('åˆå§‹åŒ–Supabase...');
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabaseåˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                showError('Supabaseåˆå§‹åŒ–å¤±è´¥: ' + error.message);
                return false;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–Supabase
            if (initializeSupabase()) {
                // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
                initializeEventListeners();
                
                // åˆå§‹åŒ–ç”¨æˆ·ç±»å‹é€‰æ‹©
                handleUserTypeChange();
                
                // åˆå§‹åŒ–æ•°æ®
                initializeData();
                
                console.log('åˆå§‹åŒ–å®Œæˆ');
            }
        });
    </script>
</body>
</html>